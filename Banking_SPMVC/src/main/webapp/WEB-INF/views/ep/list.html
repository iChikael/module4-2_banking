<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <!-- Required Meta Tags Always Come First -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Title -->
    <title>Users | Front - Admin &amp; Dashboard Template</title>

    <!-- Favicon -->
    <th:block th:replace="/ep/layout/head :: head"/>
</head>

<body class="   footer-offset">
<th:block th:replace="/ep/layout/builder :: builder"/>
<th:block th:replace="/ep/layout/headerMain :: headerMain"/>
<th:block th:replace="/ep/layout/plugin :: plugin"/>
<th:block th:replace="/ep/layout/asidebar :: asidebar"/>
<th:block th:replace="/ep/layout/searchForm :: search"/>
<th:block th:replace="/ep/layout/asidebarCompact :: sidebarCompact"/>
<main id="content" role="main" class="main">
    <!-- Content -->
    <div class="content container-fluid">
        <!-- Page Header -->
        <th:block th:replace="/ep/layout/filter :: filter"/>

        <!-- Table -->
        <div class="container-fluid">
            <div class="header">
                <nav class="navbar bg-primary">
                    <div class="container-fluid">
                        <!--                    <h2>List of customers</h2>-->
                        <div class="d-flex">
                            <button id="btnShowCreateModal" class="btn btn-light" style="margin: 2px">
                                <i class="fas fa-plus"></i>
                                Create
                            </button>

                            <button id="btnShowTransferHistoryModal" class="btn btn-light" style="margin: 2px">
                                <i class="fas fa-history"></i>
                                History
                            </button>
                        </div>
                    </div>
                </nav>
            </div>

            <div class="content">
                <table id="tbCustomer" class="table table-hover">
                    <thead>
                    <tr>
                        <th></th>
                        <th>#</th>
                        <th>Full name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Balance</th>
                        <th>Province</th>
                        <th>District</th>
                        <th>Ward</th>
                        <th>Address</th>
                    </tr>
                    </thead>
                    <tbody>

                    </tbody>
                </table>
            </div>
        </div>


        <!-- Modal Create -->
        <div id="modalCreate" class="modal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Modal create customer</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="modal-alert-danger hide"></div>
                        <form id="frmCreateCustomer" class="" method="post">
                            <input type="hidden" id="customerIdCre">
                            <div class="row mb-3">
                                <div class="col-lg-4">
                                    <label for="fullNameCre" class="form-label">Full name</label>
                                    <input type="text" class="form-control" id="fullNameCre" name="fullNameCre"/>
                                </div>
                                <div class="col-lg-4">
                                    <label for="emailCre" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="emailCre" name="emailCre"/>
                                </div>
                                <div class="col-lg-4">
                                    <label for="phoneCre" class="form-label">Phone</label>
                                    <input type="tel" class="form-control" id="phoneCre" name="phoneCre"/>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-lg-3">
                                    <label for="provinceCre" class="form-label">Province</label>
                                    <select name="provinceCre" id="provinceCre" class="form-select"></select>
                                </div>
                                <div class="col-lg-3">
                                    <label for="districtCre" class="form-label">District</label>
                                    <select name="districtCre" id="districtCre" class="form-select"></select>
                                </div>
                                <div class="col-lg-3">
                                    <label for="wardCre" class="form-label">Ward</label>
                                    <select name="wardCre" id="wardCre" class="form-select"></select>
                                </div>
                                <div class="col-lg-3">
                                    <label class="form-label">Address</label>
                                    <input type="text" class="form-control" id="addressCre" name="addressCre"/>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="btnCreateCustomer">Create</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal update -->
        <div id="modalUpdate" class="modal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Modal update customer</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="modal-alert-danger hide"></div>
                        <form id="frmUpdateCustomer" method="post">
                            <input type="hidden" id="customerIdUp">
                            <div class="row mb-3">
                                <div class="col-lg-4">
                                    <label class="form-label">Full name</label>
                                    <input type="text" class="form-control" id="fullNameUp" name="fullNameUp"/>
                                </div>
                                <div class="col-lg-4">
                                    <label class="form-label">Email</label>
                                    <input class="form-control" id="emailUp" name="emailUp"/>
                                </div>
                                <div class="col-lg-4">
                                    <label class="form-label">Phone</label>
                                    <input type="tel" class="form-control" id="phoneUp" name="phoneUp"/>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <input type="hidden" id="locationRegionIdUp">
                                <div class="col-lg-3">
                                    <label class="form-label">Province</label>
                                    <select name="provinceUp" id="provinceUp" class="form-select"></select>
                                </div>
                                <div class="col-lg-3">
                                    <label class="form-label">District</label>
                                    <select name="districtUp" id="districtUp" class="form-select"></select>
                                </div>
                                <div class="col-lg-3">
                                    <label class="form-label">Ward</label>
                                    <select name="wardUp" id="wardUp" class="form-select"></select>
                                </div>
                                <div class="col-lg-3">
                                    <label class="form-label">Address</label>
                                    <input type="text" class="form-control" id="addressUp" name="addressUp"/>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-light" id="btnUpdateCustomer">Update</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal deposit -->
        <div id="modalDeposit" class="modal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Modal deposit</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="modal-alert-danger hide"></div>
                        <form id="frmDeposit" class="" method="post">
                            <div class="row mb-3">
                                <div class="col-lg-6">
                                    <label for="idDep" class="form-label">Id</label>
                                    <input type="text" class="form-control" id="idDep" name="idDep" readonly/>
                                </div>
                                <div class="col-lg-6">
                                    <label for="fullNameDep" class="form-label">Full name</label>
                                    <input type="text" class="form-control" id="fullNameDep" name="fullNameDep" readonly/>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="mb-3 col-lg-6">
                                    <label for="balanceDep" class="form-label">Balance</label>
                                    <input type="text" class="form-control" id="balanceDep" name="balanceDep" readonly/>
                                </div>
                                <div class="mb-3 col-lg-6">
                                    <label for="transactionAmountDep" class="form-label">TransactionAmount</label>
                                    <input type="text" class="form-control" id="transactionAmountDep"
                                           name="transactionAmountDep"/>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-light" id="btnDeposit">Deposit</button>
                            </div>
                        </form>
                    </div>

                </div>
            </div>
        </div>

        <!-- Modal withdraw -->
        <div id="modalWithdraw" class="modal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Modal withdraw</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="modal-alert-danger hide"></div>
                        <form id="frmWithdraw" class="" method="post">
                            <div class="row mb-3">
                                <div class="col-lg-6">
                                    <label for="idWith" class="form-label">Id</label>
                                    <input type="text" class="form-control" id="idWith" name="idWith" readonly/>
                                </div>
                                <div class="col-lg-6">
                                    <label for="fullNameWith" class="form-label">Full name</label>
                                    <input type="text" class="form-control" id="fullNameWith" name="fullNameWith" readonly/>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="mb-3 col-lg-6">
                                    <label for="balanceWith" class="form-label">Balance</label>
                                    <input type="text" class="form-control" id="balanceWith" name="balanceWith" readonly/>
                                </div>
                                <div class="mb-3 col-lg-6">
                                    <label for="transactionAmountWith" class="form-label">TransactionAmount</label>
                                    <input type="text" class="form-control" id="transactionAmountWith"
                                           name="transactionAmountWith"/>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-light" id="btnWithdraw">Withdraw</button>
                            </div>
                        </form>
                    </div>

                </div>
            </div>
        </div>

        <!-- Modal transfer -->
        <div class="modal fade" id="transferModal">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title " id="exampleModalLabel">Transfer Money</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-alert-danger hide"></div>
                    <form method="post" id="frmTransfer">
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="fullNameTransfer" class="">FullName</label>
                                    <input class="col-md-12 form-control" type="text" id="fullNameTransfer"
                                           name="fullNameTransfer" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label for="balanceTransfer" class="">Balance</label>
                                    <input class="col-md-12 form-control" type="text" id="balanceTransfer"
                                           name="balanceTransfer" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label for="idRecipient" class="">Recipient Name</label>
                                    <select class="col-md-12 form-control" id="idRecipient" name="idRecipient">
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="transactionAmountTransfer" class="">Transfer Amount</label>
                                    <input value="0" class="col-md-12 form-control" type="text"
                                           id="transactionAmountTransfer" name="transactionAmountTransfer">
                                </div>
                                <div class="col-md-4">
                                    <label for="feeAmountTransfer" class="">Fee Amount</label>
                                    <input value="10%" class="col-md-12 form-control" type="text"
                                           id="feeAmountTransfer" name="feeAmountTransfer" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label for="totalAmountTransfer" class="">Total Amount</label>
                                    <input class="col-md-12 form-control" type="text" id="totalAmountTransfer"
                                           name="totalAmountTransfer" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary"
                                    data-bs-dismiss="modal">Cancel
                            </button>
                            <button type="button" id="btnTransfer" class="btn btn-outline-primary">Transfer</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="modal fade" id="modalTransferHistory">
            <div class="modal-dialog modal-xl modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5">Transfer History</h1>
                        <button type="button" class="btn-close close-modal" data-bs-dismiss="modal" aria-label="Close">
                        </button>
                    </div>
                    <div class="modal-body">
                        <table id="tbTransferHistory" class="table table-hover" style="background-color: #2c3034">
                            <thead>
                            <tr>
                                <th>#</th>
                                <th>Sender Name</th>
                                <th>Recipient Name</th>
                                <th>Transfer Amount</th>
                                <th>FeesAmount</th>
                                <th>Transaction Amount</th>
                            </tr>
                            </thead>
                            <tbody>

                            </tbody>
                        </table>
                    </div>
                    <div class=" modal-footer">
                        <button type="button" class="btn btn-secondary close-modal" data-bs-dismiss="modal">Close
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <footer class="container-fluid hide">
            <div class="container">

            </div>
        </footer>

        <script src="/assets/jquery/jquery-3.6.4.min.js"></script>
        <!--    <script src="/assets/jquery/jquery.validate.min.js"></script>-->
        <script src="/assets/bootstrap/v5.3.0/js/bootstrap.bundle.min.js"></script>
        <script src="/assets/sweetalert2/sweetalert2.all.min.js"></script>
        <script src="/assets/js/appbase.js"></script>

        <script>

            const page = {
                urls: {
                    getAllCustomers: AppBase.API_CUSTOMER,
                    findCustomerById: AppBase.DOMAIN_API + "/customers",
                    createCustomer: AppBase.API_CUSTOMER,
                    updateCustomerById: AppBase.DOMAIN_API + "/customers",
                    doDeposit: AppBase.API_CUSTOMER + '/deposits',
                    doWithdraw: AppBase.API_CUSTOMER + '/withdraws',
                    doTransfer: AppBase.API_CUSTOMER + '/transfers',
                    getAllTransfers: AppBase.API_CUSTOMER + '/transfers'


                },
                elements: {},
                loadData: {},
                commands: {},
                dialogs: {
                    elements: {},
                    loadData: {},
                    commands: {}
                }
            }


            let currentCustomer = null;

            let locationRegion = new LocationRegion();

            let customer = new Customer();
            let deposit = new Deposit();
            let withdraw = new Withdraw();


            page.elements.btnShowCreateModal = $('#btnShowCreateModal');

            page.dialogs.elements.customerIdCre = $('#customerIdCre');
            page.dialogs.elements.modalCreate = $('#modalCreate');
            page.dialogs.elements.frmCreateCustomer = $('#frmCreateCustomer');
            page.dialogs.elements.fullNameCre = $('#fullNameCre');
            page.dialogs.elements.emailCre = $('#emailCre');
            page.dialogs.elements.phoneCre = $('#phoneCre');
            page.dialogs.elements.provinceCre = $('#provinceCre');
            page.dialogs.elements.districtCre = $('#districtCre');
            page.dialogs.elements.wardCre = $('#wardCre');
            page.dialogs.elements.addressCre = $('#addressCre');
            page.dialogs.elements.btnCreate = $('#btnCreateCustomer')

            page.dialogs.elements.customerIdUp = $('#customerIdUp');
            page.dialogs.elements.modalUpdate = $('#modalUpdate');
            page.dialogs.elements.frmUpdateCustomer = $('#frmUpdateCustomer');
            page.dialogs.elements.fullNameUp = $('#fullNameUp');
            page.dialogs.elements.emailUp = $('#emailUp');
            page.dialogs.elements.phoneUp = $('#phoneUp');
            page.dialogs.elements.locationRegionIdUp = $('#locationRegionIdUp');
            page.dialogs.elements.provinceUp = $('#provinceUp');
            page.dialogs.elements.districtUp = $('#districtUp');
            page.dialogs.elements.wardUp = $('#wardUp');
            page.dialogs.elements.addressUp = $('#addressUp');
            page.dialogs.elements.btnUpdate = $('#btnUpdateCustomer')

            page.dialogs.elements.modalDeposit = $('#modalDeposit');
            page.dialogs.elements.frmDeposit = $('#frmDeposit');
            page.dialogs.elements.idDep = $('#idDep');
            page.dialogs.elements.fullNameDep = $('#fullNameDep');
            page.dialogs.elements.balanceDep = $('#balanceDep');
            page.dialogs.elements.transactionAmountDep = $('#transactionAmountDep');
            page.dialogs.elements.btnDeposit = $('#btnDeposit');

            page.dialogs.elements.modalWithdraw = $('#modalWithdraw');
            page.dialogs.elements.frmWithdraw = $('#frmWithdraw');
            page.dialogs.elements.idWith = $('#idWith');
            page.dialogs.elements.fullNameWith = $('#fullNameWith');
            page.dialogs.elements.balanceWith = $('#balanceWith');
            page.dialogs.elements.transactionAmountWith = $('#transactionAmountWith');
            page.dialogs.elements.btnWithdraw = $('#btnWithdraw');

            page.elements.btnTransfer = $('#btnTransfer');
            page.dialogs.elements.modalTransfer = $('#transferModal');
            page.dialogs.elements.frmTransfer = $("#frmTransfer");

            page.loadData.getAllCustomers = () => {
                $.ajax({
                    type: "GET",
                    url: page.urls.getAllCustomers
                })
                    .done((data) => {
                        $.each(data, (i, item) => {
                            customer = item;
                            locationRegion = customer.locationRegion;
                            let str = renderCustomer(customer, locationRegion);
                            $('#tbCustomer tbody').prepend(str);

                        })

                        page.commands.addEventShowActionButton();


                    })
                    .fail((error) => {
                        console.error(error);
                    })
            }
            function getAllTransferHistory() {
                $.ajax({
                    headers: {
                        "accept": "application/json",
                        "content-type": "application/json"
                    },
                    type: "GET",
                    url: page.urls.getAllTransfers
                })
                    .done((data) => {
                        $.each(data, (i, transfer) => {
                            let str = renderTransferHistory(transfer);
                            console.log(transfer)
                            $("#tbTransferHistory tbody").append(str);
                        })
                    })
                    .fail((error) => {
                        console.log(error);
                    });
            }


            page.dialogs.loadData.getAllProvinces = () => {
                return $.ajax({
                    type: 'GET',
                    url: 'https://vapi.vnappmob.com/api/province/'
                })
                    .done((data) => {
                        $.each(data.results, (i, item) => {
                            let str = `<option value="${item.province_id}">${item.province_name}</option>`;

                            page.dialogs.elements.provinceCre.append(str);
                            page.dialogs.elements.provinceUp.append(str);

                        })

                        addEventChangeProvince();
                        addEventChangeDistrict();

                    })
                    .fail((jqXHR) => {
                        AppBase.SweetAlert.showErrorAlert('Load Provinces fail');
                    })
            }

            function addEventChangeProvince() {
                page.dialogs.elements.provinceCre.on("change", function () {
                    let provinceId = $(this).val();

                    if (provinceId !== 0) {
                        page.dialogs.loadData.getAllDistrictsByProvince(provinceId).then(() => {
                            let districtId = page.dialogs.elements.districtCre.val();
                            page.dialogs.loadData.getAllWardsByDistrict(districtId);
                        })
                    }
                })
            }

            function addEventChangeProvinceUp() {
                page.dialogs.elements.provinceUp.on("change", function () {
                    let provinceId = $(this).val();
                    if (provinceId !== 0) {
                        page.dialogs.loadData.getAllDistrictsByProvince(provinceId).then(() => {
                            let districtId = page.dialogs.elements.districtUp.val();
                            page.dialogs.loadData.getAllWardsByDistrict(districtId);
                        })
                    }
                })
            }

            function addEventChangeDistrictUp() {

                page.dialogs.elements.districtUp.on("change", function () {
                    let districtId = $(this).val();

                    if (districtId !== 0) {
                        page.dialogs.loadData.getAllWardsByDistrict(districtId);
                    }

                })
            }


            page.dialogs.loadData.getAllDistrictsByProvince = (provinceId) => {
                return $.ajax({
                    type: 'GET',
                    url: 'https://vapi.vnappmob.com/api/province/district/' + provinceId
                })
                    .done((data) => {
                        // console.log(data)
                        let dir = data.results;
                        page.dialogs.elements.districtCre.empty();
                        page.dialogs.elements.districtUp.empty();
                        $.each(dir, (i, item) => {
                            let str = `<option value="${item.district_id}">${item.district_name}</option>`;

                            page.dialogs.elements.districtCre.append(str);
                            page.dialogs.elements.districtUp.append(str);

                        })


                    })
                    .fail((jqXHR) => {
                        AppBase.SweetAlert.showErrorAlert('Load Districts fail');
                    })
            }

            function addEventChangeDistrict() {

                page.dialogs.elements.districtCre.on("change", function () {
                    let districtId = $(this).val();

                    if (districtId !== 0) {

                        page.dialogs.loadData.getAllWardsByDistrict(districtId);
                    }

                })
            }


            page.dialogs.loadData.getAllWardsByDistrict = (districtId) => {
                return $.ajax({
                    type: 'GET',
                    url: 'https://vapi.vnappmob.com/api/province/ward/' + districtId
                })
                    .done((data) => {
                        page.dialogs.elements.wardCre.empty();
                        page.dialogs.elements.wardUp.empty();
                        $.each(data.results, (i, item) => {
                            let str = `<option value="${item.ward_id}">${item.ward_name}</option>`;

                            page.dialogs.elements.wardCre.append(str);
                            page.dialogs.elements.wardUp.append(str);
                        })


                    })
                    .fail((jqXHR) => {
                        AppBase.SweetAlert.showErrorAlert('Load Wards fail');
                    })
            }

            page.commands.addEventShowActionButton = () => {
                $('#tbCustomer tbody tr').on('click', function () {

                    $('#tbCustomer tbody tr').find('td:eq(0)').find('span').removeClass('selected').addClass('unselected');
                    $(this).find('td').first().find('span').removeClass('unselected').addClass('selected');

                    currentCustomerId = $(this).attr("id").replace("tr_", "");

                    let str = `
                    <button class="btn btn-secondary edit" data-id="${currentCustomerId}">
                        <i class="far fa-edit"></i>
                        Update
                    </button>
                    <button class="btn btn-success deposit" data-id="${currentCustomerId}">
                        <i class="fas fa-plus"></i>
                        Deposit
                    </button>
                    <button class="btn btn-warning withdraw" data-id="${currentCustomerId}">
                        <i class="fas fa-minus"></i>
                        Withdraw
                    </button>
                    <button class="btn btn-primary transfer" data-id="${currentCustomerId}">
                        <i class="fas fa-exchange-alt"></i>
                        Transfer
                    </button>
                    <button class="btn btn-danger delete" data-id="${currentCustomerId}">
                        <i class="fas fa-trash-alt"></i>
                        Delete
                    </button>
                `;

                    $('footer').removeClass('hide');
                    $('footer .container').html(str);

                    addEventUpdateCustomer();
                    page.dialogs.commands.addEventDeposit();
                    page.dialogs.commands.addEventWithdraw();
                    addEventTransfer();
                    addEventDeleteCustomer();

                    page.commands.addEventFooterButton();
                })
            }


            page.commands.addEventFooterButton = () => {
                $('footer button').on('click', () => {
                    $('footer').addClass('hide');
                    $('footer .container').empty();
                })
            }


            page.loadData.findCustomerById = (id) => {
                return $.ajax({
                    type: "GET",
                    url: page.urls.findCustomerById + '/' + id
                })
                    .fail((error) => {
                        console.error(error);
                    })
            }

            // let updateCustomerById = (obj) => {
            //     customers.filter(item => {
            //         if (item.id == obj.id) {
            //             item.fullName = obj.fullName;
            //             item.email = obj.email;
            //             item.phone = obj.phone;
            //             item.address = obj.address;
            //         }
            //     })
            // }

            let addEventUpdateCustomer = () => {
                $('.edit').on('click', function () {
                    let id = $(this).data('id');

                    page.loadData.findCustomerById(id).then((customer) => {
                        currentCustomer = customer;
                        locationRegion = customer.locationRegion;

                        page.dialogs.elements.customerIdUp.val(customer.id);
                        page.dialogs.elements.fullNameUp.val(customer.fullName);
                        page.dialogs.elements.emailUp.val(customer.email);
                        page.dialogs.elements.phoneUp.val(customer.phone);

                        page.dialogs.elements.locationRegionIdUp.val(locationRegion.id);
                        page.dialogs.elements.provinceUp.val(locationRegion.provinceId);

                        page.dialogs.loadData.getAllDistrictsByProvince(locationRegion.provinceId).then(() => {
                            page.dialogs.elements.districtUp.val(locationRegion.districtId);
                            page.dialogs.loadData.getAllWardsByDistrict(locationRegion.districtId).then(() => {
                                page.dialogs.elements.wardUp.val(locationRegion.wardId);
                                page.dialogs.elements.addressUp.val(locationRegion.address);

                            })
                        })
                        page.dialogs.elements.modalUpdate.modal('show');
                        addEventChangeProvinceUp();
                        addEventChangeDistrictUp();
                    })
                        .catch(() => {
                            alert('Customer not found');
                        });
                })
            }


            let addEventDeleteCustomer = () => {
                $('.delete').on('click', function () {

                    let customerId = $(this).data('id');
                    page.loadData.findCustomerById(customerId).then(() => {
                        AppBase.SweetAlert.showDeleteConfirmDialog().then((result) => {
                            if (result.isConfirmed) {
                                page.commands.deleteCustomer(customerId);
                            }
                        })
                    })
                })
            }


            page.commands.deleteCustomer = (id) => {
                $.ajax({
                    headers: {
                        'accept': 'application/json',
                        'content-type': 'application/json'
                    },
                    type: 'PATCH',
                    url: 'http://localhost:8080/api/customers/delete/' + id,

                })
                    .done((data) => {
                        console.log(data)
                        $('#tr_' + id).remove();
                        Swal.fire({
                            position: 'top-end',
                            icon: 'success',
                            title: 'Customer has been deleted.',
                            showConfirmButton: false,
                            timer: 2000
                        })
                    })
                    .fail(() => {

                        Swal.fire({
                            position: 'center',
                            icon: 'error',
                            title: 'Failed to delete customer',
                        })
                    })
            }


            let removeEventUpdateCustomer = () => {
                $('.edit').off('click');
            }

            let doCreateCustomer = () => {
                // let id = generateId();
                let fullName = page.dialogs.elements.fullNameCre.val();
                let email = page.dialogs.elements.emailCre.val();
                let phone = page.dialogs.elements.phoneCre.val();
                let provinceId = page.dialogs.elements.provinceCre.val();
                let provinceName = page.dialogs.elements.provinceCre.find('option:selected').text();
                let districtId = page.dialogs.elements.districtCre.val();
                let districtName = page.dialogs.elements.districtCre.find('option:selected').text();
                let wardId = page.dialogs.elements.wardCre.val();
                let wardName = page.dialogs.elements.wardCre.find('option:selected').text();
                let address = page.dialogs.elements.addressCre.val();
                let balance = 0;
                let deleted = 0;


                locationRegion.provinceId = provinceId;
                locationRegion.provinceName = provinceName;
                locationRegion.districtId = districtId;
                locationRegion.districtName = districtName;
                locationRegion.wardId = wardId;
                locationRegion.wardName = wardName;
                locationRegion.address = address;

                customer.id = null;
                customer.fullName = fullName;
                customer.email = email;
                customer.phone = phone;
                customer.locationRegion = locationRegion;
                customer.balance = balance;
                customer.deleted = deleted;


                $.ajax({
                    headers: {
                        'accept': 'application/json',
                        'content-type': 'application/json'
                    },
                    type: "POST",
                    url: page.urls.createCustomer,
                    data: JSON.stringify(customer)
                })
                    .done((data) => {
                        customer = data;
                        locationRegion = customer.locationRegion;

                        let str = renderCustomer(customer, locationRegion);
                        $('#tbCustomer tbody').prepend(str);

                        page.commands.addEventShowActionButton();
                        removeEventUpdateCustomer();

                        $('#modalCreate').modal('hide');

                        AppBase.SweetAlert.showSuccessAlert('New customer is created successfully');
                    })
                    .fail((error) => {
                        AppBase.SweetAlert.showErrorAlert('Create new customer failed');
                    })
            }


            let doUpdateCustomer = () => {
                let id = currentCustomer.id;
                let fullName = $('#fullNameUp').val();
                let email = $('#emailUp').val();
                let phone = $('#phoneUp').val();
                let provinceId = page.dialogs.elements.provinceUp.val();
                let provinceName = page.dialogs.elements.provinceUp.find('option:selected').text();
                let districtId = page.dialogs.elements.districtUp.val();
                let districtName = page.dialogs.elements.districtUp.find('option:selected').text();
                let wardId = page.dialogs.elements.wardUp.val();
                let wardName = page.dialogs.elements.wardUp.find('option:selected').text();
                let address = $('#addressUp').val();

                locationRegion.provinceId = provinceId;
                locationRegion.provinceName = provinceName;
                locationRegion.districtId = districtId;
                locationRegion.districtName = districtName;
                locationRegion.wardId = wardId;
                locationRegion.wardName = wardName;

                currentCustomer.fullName = fullName;
                currentCustomer.email = email;
                currentCustomer.phone = phone;
                currentCustomer.locationRegion = locationRegion;
                currentCustomer.address = address;
                $.ajax({
                    headers: {
                        'accept': 'application/json',
                        'content-type': 'application/json'
                    },
                    type: 'PATCH',
                    url: page.urls.updateCustomerById + '/' + id,
                    data: JSON.stringify(currentCustomer)
                })
                    .done((data) => {
                        currentCustomer = data;

                        let newRow = renderCustomer(currentCustomer, currentCustomer.locationRegion);
                        let currentRow = $('#tr_' + id);

                        currentRow.replaceWith(newRow);


                        page.commands.addEventShowActionButton();
                        removeEventUpdateCustomer();

                        $('#modalUpdate').modal('hide');

                        AppBase.SweetAlert.showSuccessAlert('New customer is updated successfully');
                    })
                    .fail((error) => {
                        AppBase.SweetAlert.showErrorAlert('Update new customer failed');
                    })
            }
            page.dialogs.commands.addEventDeposit = () => {
                $('.deposit').on('click', function () {
                    let customerId = $(this).data('id');

                    page.loadData.findCustomerById(customerId).then((data) => {
                        currentCustomer = data;

                        page.dialogs.elements.idDep.val(currentCustomer.id);
                        page.dialogs.elements.fullNameDep.val(currentCustomer.fullName);
                        page.dialogs.elements.balanceDep.val(currentCustomer.balance);

                        page.dialogs.elements.modalDeposit.modal('show');
                    })
                        .catch(() => {
                            AppBase.SweetAlert.showErrorAlert('Customer not found');
                        })
                })
            }

            page.dialogs.commands.doDeposit = () => {

                let id = page.dialogs.elements.idDep.val();
                let transactionAmount = +$('#transactionAmountDep').val();

                let depObj = {
                    transactionAmount
                }
                page.dialogs.commands.createDeposit(id, depObj).then((data) => {
                    let currentCustomer = data;
                    let newRow = renderCustomer(currentCustomer, currentCustomer.locationRegion);
                    let currentRow = $('#tr_' + id);

                    currentRow.replaceWith(newRow);

                    $(".edit").off("click");
                    $(".delete").off("click");
                    $(".deposit").off("click");
                    $(".transfer").off("click");

                    page.commands.addEventShowActionButton();

                    $('#modalDeposit').modal('hide');

                    AppBase.SweetAlert.showSuccessAlert('Deposit success');
                })
                    .catch(() => {
                        AppBase.SweetAlert.showErrorAlert('Deposit fail');
                    });
            }


            page.dialogs.commands.createDeposit = (id, depObj) => {
                return $.ajax({
                    headers: {
                        'accept': 'application/json',
                        'content-type': 'application/json'
                    },
                    type: 'POST',
                    url: page.urls.doDeposit + "/" + id,
                    data: JSON.stringify(depObj)
                })
                    .done((data) => {
                        deposit = data;
                    })
            }

            page.dialogs.commands.addEventWithdraw = () => {
                $('.withdraw').on('click', function () {
                    let customerId = $(this).data('id');

                    page.loadData.findCustomerById(customerId).then((data) => {
                        currentCustomer = data;

                        page.dialogs.elements.idWith.val(currentCustomer.id);
                        page.dialogs.elements.fullNameWith.val(currentCustomer.fullName);
                        page.dialogs.elements.balanceWith.val(currentCustomer.balance);

                        page.dialogs.elements.modalWithdraw.modal('show');
                    })
                        .catch(() => {
                            AppBase.SweetAlert.showErrorAlert('Customer not found');
                        })
                })
            }

            page.dialogs.commands.doWithdraw = () => {

                let id = page.dialogs.elements.idWith.val();
                let transactionAmount = +$('#transactionAmountWith').val();

                let withObj = {
                    transactionAmount
                }
                page.dialogs.commands.createWithdraw(id, withObj).then((data) => {
                    let currentCustomer = data;
                    let newRow = renderCustomer(currentCustomer, currentCustomer.locationRegion);
                    let currentRow = $('#tr_' + id);

                    currentRow.replaceWith(newRow);

                    $(".edit").off("click");
                    $(".delete").off("click");
                    $(".deposit").off("click");
                    $(".withdraw").off("click");
                    $(".transfer").off("click");

                    page.commands.addEventShowActionButton();

                    $('#modalWithdraw').modal('hide');

                    AppBase.SweetAlert.showSuccessAlert('Withdraw success');
                })
                    .catch(() => {
                        AppBase.SweetAlert.showErrorAlert('Withdraw fail');
                    });
            }


            page.dialogs.commands.createWithdraw = (id, withObj) => {
                return $.ajax({
                    headers: {
                        'accept': 'application/json',
                        'content-type': 'application/json'
                    },
                    type: 'POST',
                    url: page.urls.doWithdraw + "/" + id,
                    data: JSON.stringify(withObj)
                })
                    .done((data) => {
                        console.log(data);
                        withdraw = data;
                    })
            }


            page.commands.doTransfer = () => {
                let senderId = currentCustomerId;
                let recipientId = +$("#idRecipient").val();
                let transferAmount = +$("#transactionAmountTransfer").val();


                let transferObj = {
                    senderId,
                    recipientId,
                    transferAmount
                }
                page.commands.transfer(transferObj);
            }
            page.commands.transfer = (transferObj) => {
                $.ajax({
                    headers: {
                        'accept': 'application/json',
                        'content-type': 'application/json'
                    },
                    type: "POST",
                    url: page.urls.doTransfer,
                    data: JSON.stringify(transferObj)
                })
                    .done((data) => {
                        let sender = data.sender;
                        locationRegion = sender.locationRegion;
                        let strSendr = renderCustomer(sender, locationRegion);
                        $("#tr_" + sender.id).replaceWith(strSendr);

                        let recipient = data.recipient;
                        locationRegion = recipient.locationRegion;
                        let strRecipient = renderCustomer(recipient, locationRegion);
                        $("#tr_" + recipient.id).replaceWith(strRecipient);




                        $(".edit").off("click");
                        $(".delete").off("click");
                        $(".deposit").off("click");
                        $(".withdraw").off("click");
                        $(".transfer").off("click");
                        page.commands.addEventShowActionButton();
                        page.dialogs.elements.modalTransfer.modal("hide");
                        AppBase.SweetAlert.showSuccessAlert('Transfer success');

                    })
                    .fail((error) => {
                        console.log(error);
                    })
            }



            function addEventTransfer() {
                $(".transfer").on('click', function () {
                    let customerId = $(this).data('id');

                    page.loadData.findCustomerById(customerId).then((customer) => {
                        currentCustomerId = customerId;
                        console.log(currentCustomerId);
                        page.loadData.getAllRecipient(customerId);
                        $("#idRecipient").val(page.loadData.getAllRecipient(currentCustomerId));
                        $("#idTransfer").val(customer.id);
                        $("#fullNameTransfer").val(customer.fullName);
                        $("#balanceTransfer").val(customer.balance);

                        page.dialogs.elements.modalTransfer.modal("show");
                    })
                        .catch((error) => {
                            alert("Not found this customer");
                        });
                })
            }

            page.loadData.getAllRecipient = (senderId) => {
                $.ajax({
                    headers: {
                        'accept': 'application/json',
                        'content-type': 'application/json'
                    },
                    type: "GET",
                    url: page.urls.getAllCustomers + "?deleted=0&id_ne=" + senderId
                })
                    .done((data) => {
                        $("#idRecipient").empty();
                        $.each(data, (i, item) => {
                            if (item.id != senderId) {
                                let str = `<option value="${item.id}">(${item.id}) - ${item.fullName}</option>`
                                $("#idRecipient").append(str);
                            }
                        })

                    })
                    .fail((error) => {
                        console.log(error);
                    })
            }

            let renderCustomer = (customer, locationRegion) => {
                return `
                <tr id="tr_${customer.id}" class="customerId" data-id="${customer.id}">
                    <td><span class="select-tab unselected"></span></td>
                    <td>${customer.id}</td>
                    <td>${customer.fullName}</td>
                    <td>${customer.email}</td>
                    <td>${customer.phone}</td>
                    <td>${customer.balance}</td>
                    <td>${locationRegion.provinceName}</td>
                    <td>${locationRegion.districtName}</td>
                    <td>${locationRegion.wardName}</td>
                    <td>${locationRegion.address}</td>
                </tr>
            `;
            }

            function renderTransferHistory(transferViewDTO) {
                console.log(transferViewDTO)
                return `<tr>
                <th scope="row">${transferViewDTO.id}</th>
                <td>${transferViewDTO.senderName}</td>
                <td>${transferViewDTO.recipientName}</td>
                <td>${transferViewDTO.transferAmount}</td>
                <td>${transferViewDTO.feesAmount}</td>
                <td>${transferViewDTO.transactionAmount}</td>
            </tr>
        `
            }


            $("#btnShowTransferHistoryModal").on("click", () => {
                getAllTransferHistory();
                $("#modalTransferHistory").modal("show");
            })

            $("#modalTransferHistory").on("hidden.bs.modal", () => {
                $("#tbTransferHistory tbody").empty();
            })


            $('.modal').on('hidden.bs.modal', () => {
                $('#frmCreateCustomer')[0].reset();
                resetLocationRegion();
                $('#frmCreateCustomer').validate().resetForm();
                page.dialogs.elements.frmUpdateCustomer[0].reset();
                page.dialogs.elements.frmDeposit[0].reset();
                page.dialogs.elements.frmWithdraw[0].reset();
                page.dialogs.elements.frmTransfer[0].reset();
                $('.modal .modal-alert-danger').empty().removeClass("show").addClass("hide");
                $('.modal').find("input.error").removeClass("error");
            })

            $('#frmCreateCustomer').validate({
                rules: {
                    fullNameCre: {
                        required: true,
                        minlength: 5,
                        maxlength: 20
                    },
                    emailCre: {
                        required: true,
                        minlength: 5,
                        maxlength: 40
                    },
                    phoneCre: {
                        required: true,
                    },
                    provinceCre: {
                        required: true,
                    },
                    districtCre: {
                        required: true,
                    },
                    wardCre: {
                        required: true,
                    }

                },
                messages: {
                    fullNameCre: {
                        required: 'Full name is required',
                        minlength: 'Min character of full name is ${0}',
                        maxlength: 'Max character of full name is ${0}'
                    },
                    emailCre: {
                        required: 'Email is required',
                        minlength: 'Min character of email is ${0}',
                        maxlength: 'Max character of email is ${0}'
                    },
                    phoneCre: {
                        required: 'Phone is required',
                    },
                    provinceCre: {
                        required: "Select province",
                    },
                    districtCre: {
                        required: "Select district",
                    },
                    wardCre: {
                        required: "Select ward"
                    }
                },
                errorLabelContainer: "#modalCreate .modal-alert-danger",
                errorPlacement: function (error, element) {
                    error.appendTo("#modalCreate .modal-alert-danger");
                },
                showErrors: function (errorMap, errorList) {
                    if (this.numberOfInvalids() > 0) {
                        $("#modalCreate .modal-alert-danger").removeClass("hide").addClass("show");
                    } else {
                        $("#modalCreate .modal-alert-danger").removeClass("show").addClass("hide").empty();
                        $("#frmCreateCustomer input.error").removeClass("error");
                    }
                    this.defaultShowErrors();
                },
                submitHandler: function () {
                    doCreateCustomer();
                }
            });

            page.dialogs.elements.frmUpdateCustomer.validate({
                rules: {
                    fullNameUp: {
                        required: true,
                        minlength: 5,
                        maxlength: 20
                    },
                    emailUp: {
                        required: true,
                        minlength: 5,
                        maxlength: 40
                    },
                    phoneUp: {
                        required: true,
                    },
                    provinceUp: {
                        required: true,
                    },
                    districtUp: {
                        required: true,
                    },
                    wardUp: {
                        required: true,
                    }

                },
                messages: {
                    fullNameUp: {
                        required: 'Full name is required',
                        minlength: 'Min character of full name is ${0}',
                        maxlength: 'Max character of full name is ${0}'
                    },
                    emailUp: {
                        required: 'Email is required',
                        minlength: 'Min character of email is ${0}',
                        maxlength: 'Max character of email is ${0}'
                    },
                    phoneUp: {
                        required: 'Phone is required',
                    },
                    provinceUp: {
                        required: "Select province",
                    },
                    districtUp: {
                        required: "Select district",
                    },
                    wardUp: {
                        required: "Select ward"
                    }
                },
                errorLabelContainer: "#modalUpdate .modal-alert-danger",
                errorPlacement: function (error, element) {
                    error.appendTo("#modalUpdate .modal-alert-danger");
                },
                showErrors: function (errorMap, errorList) {
                    if (this.numberOfInvalids() > 0) {
                        console.log(this.numberOfInvalids())
                        $("#modalUpdate .modal-alert-danger").removeClass("hide").addClass("show");
                    } else {
                        $("#modalUpdate .modal-alert-danger").removeClass("show").addClass("hide").empty();
                        $("#frmUpdateCustomer input.error").removeClass("error");
                    }
                    this.defaultShowErrors();
                },
                submitHandler: function () {
                    doUpdateCustomer();
                }
            });


            page.dialogs.elements.frmDeposit.validate({
                rules: {
                    transactionAmountDep: {
                        required: true,
                        number: true,
                        min: 1000,
                        max: 1000000
                    }
                },
                messages: {
                    transactionAmountDep: {
                        required: 'Transaction amount is required',
                        number: 'Transaction amount must be number',
                        min: 'Transaction amount must be more than ${0}',
                        max: 'Transaction amount must be less than ${0}'
                    }
                },
                errorLabelContainer: "#modalDeposit .modal-alert-danger",
                errorPlacement: function (error, element) {
                    error.appendTo("#modalDeposit .modal-alert-danger");
                },
                showErrors: function (errorMap, errorList) {
                    console.log(errorMap)
                    console.log(errorList)
                    if (this.numberOfInvalids() > 0) {
                        $("#modalDeposit .modal-alert-danger").removeClass("hide").addClass("show");
                    } else {
                        $("#modalDeposit .modal-alert-danger").removeClass("show").addClass("hide").empty();
                        $("#frmDeposit input.error").removeClass("error");
                    }
                    this.defaultShowErrors();
                },
                submitHandler: function () {
                    page.dialogs.commands.doDeposit();
                }
            });


            page.dialogs.elements.frmWithdraw.validate({
                rules: {
                    transactionAmountWith: {
                        required: true,
                        number: true,
                        min: 1000,
                        max: 1000000,
                        isBiggerThanBalance: true
                    }
                },
                messages: {
                    transactionAmountWith: {
                        required: 'Transaction amount is required',
                        number: 'Transaction amount must be number',
                        min: 'Transaction amount must be more than ${0}',
                        max: 'Transaction amount must be less than ${0}'
                    }
                },
                errorLabelContainer: "#modalWithdraw .modal-alert-danger",
                errorPlacement: function (error, element) {
                    error.appendTo("#modalWithdraw .modal-alert-danger");
                },
                showErrors: function (errorMap, errorList) {
                    if (this.numberOfInvalids() > 0) {
                        $("#modalWithdraw .modal-alert-danger").removeClass("hide").addClass("show");
                    } else {
                        $("#modalWithdraw .modal-alert-danger").removeClass("show").addClass("hide").empty();
                        $("#frmWithdraw input.error").removeClass("error");
                    }
                    this.defaultShowErrors();
                },
                submitHandler: function () {
                    page.dialogs.commands.doWithdraw();
                }
            });
            $.validator.addMethod("isBiggerThanBalance", function (value, element) {
                return this.optional(element) || value <= $('#balanceWith').val();
            }, "Transfer amount must be less than your current balance!");


            $.validator.addMethod("isBiggerThanSenderBalance", function (value, element) {
                return this.optional(element) || checkSenderBalance();
            }, "Transfer amount must be less than your current balance!");


            function checkSenderBalance() {
                let totalAmount = +$("#totalAmountTransfer").val();
                let senderBalance = +$("#balanceTransfer").val();
                return totalAmount <= senderBalance;
            }


            page.dialogs.elements.frmTransfer.validate({
                rules: {
                    transactionAmountTransfer: {
                        required: true,
                        min: 1000,
                        max: 1000000,
                        isBiggerThanSenderBalance: true,
                    }
                },
                messages: {
                    transactionAmountTransfer: {
                        required: "Please enter the amount you want to transfer",
                        min: "Transaction amount must be more than ${0} ",
                        max: "Transaction amount must be less than ${0}",
                        isBiggerThanSenderBalance: "Your balance is not available"
                    }
                },
                errorLabelContainer: "#transferModal .modal-alert-danger",
                errorPlacement: function (error, element) {
                    error.appendTo("#transferModal .modal-alert-danger");
                },
                showErrors: function (errorMap, errorList) {
                    if (this.numberOfInvalids() > 0) {
                        $("#transferModal .modal-alert-danger").removeClass("hide").addClass("show");
                    } else {
                        $("#transferModal .modal-alert-danger").removeClass("show").addClass("hide").empty();
                        $("#formTransfer input.error").removeClass("error");
                    }
                    this.defaultShowErrors();
                },
                submitHandler: function () {
                    page.commands.doTransfer();
                }
            })

            page.elements.btnShowCreateModal.on('click', () => {
                page.dialogs.elements.modalCreate.modal('show');
            })

            page.initializeControlEvent = () => {

                $('#btnCreateCustomer').on('click', () => {
                    $('#frmCreateCustomer').trigger('submit');
                })
                $('#btnUpdateCustomer').on('click', function () {
                    $('#frmUpdateCustomer').trigger('submit');
                })
                page.dialogs.elements.btnDeposit.on('click', function () {
                    $('#frmDeposit').trigger('submit');
                })
                page.elements.btnTransfer.on('click', function () {
                    $('#frmTransfer').trigger('submit');
                });
                page.dialogs.elements.btnWithdraw.on('click', function () {
                    $('#frmWithdraw').trigger('submit');
                })
            }


            $(() => {
                page.loadData.getAllCustomers();
                page.initializeControlEvent();

                resetLocationRegion();

            })

            function resetLocationRegion() {
                page.dialogs.loadData.getAllProvinces().then(() => {
                    let provinceId = page.dialogs.elements.provinceCre.val();

                    page.dialogs.loadData.getAllDistrictsByProvince(provinceId).then(() => {
                        let districtId = page.dialogs.elements.districtCre.val();

                        page.dialogs.loadData.getAllWardsByDistrict(districtId);
                    });
                });
            }

        </script>

        <script>
            let transferAmountElem = document.getElementById("transactionAmountTransfer");
            transferAmountElem.addEventListener("input", function () {
                let transferAmount = +transferAmountElem.value;
                let fees = 10;
                let feesAmount = transferAmount * fees / 100;
                let transactionAmount = transferAmount + feesAmount;
                document.getElementById("totalAmountTransfer").value = transactionAmount;
            })
        </script>
    </div>
</main>

<div class="modal fade" id="editUserModal" tabindex="-1" role="dialog" aria-labelledby="editUserModalTitle"
     aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <!-- Header -->
            <div class="modal-header">
                <h4 id="editUserModalTitle" class="modal-title">Edit user</h4>

                <button type="button" class="btn btn-icon btn-sm btn-ghost-secondary" data-dismiss="modal"
                        aria-label="Close">
                    <i class="tio-clear tio-lg"></i>
                </button>
            </div>
            <!-- End Header -->

            <!-- Body -->

        <!-- End Body -->
    </div>
</div>
</div>

<th:block th:replace="/ep/layout/script :: script"/>
</body>
</html>
